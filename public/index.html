<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>StealthMonitor – Map</title>

  <!-- CSS via CDN para evitar problemas de static serve -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+gHk6Gg4TR+WvP2qHCZubXVy1HQEgs4v1tqYt2jfk="
    crossorigin=""
  />

  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    #fallback {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      font-family:sans-serif; color:#666;
      text-align:center;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="fallback" style="display:none;">
    <p>Carregando mapa...</p>
    <p>Se continuar branco, verifique a conexão ou o console do navegador.</p>
  </div>

  <!-- JS via CDN -->
  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-kG14XSPAsYxQbL7Q6ey8qCMbKg2Ykef9QbsGU4R+DrM="
    crossorigin=""
  ></script>

  <script>
    const fallback = document.getElementById('fallback');
    const mapDiv   = document.getElementById('map');

    // Tenta inicializar o mapa, se falhar exibe fallback
    try {
      const map = L.map('map').setView([0, 0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      // Fetch dados
      fetch('/api/data')
        .then(res => res.json())
        .then(points => {
          console.log('Pontos recebidos:', points);
          if (points.length === 0) {
            console.log('Nenhum ponto para plotar ainda.');
          }
          points.forEach(p => {
            if (p.location && p.location.lat) {
              L.marker([p.location.lat, p.location.lng])
               .bindPopup(`<b>${p.username}</b><br>${new Date(p.timestamp).toLocaleString()}`)
               .addTo(map);
            }
          });
        })
        .catch(err => console.error('Erro carregando /api/data:', err));
    } catch (e) {
      console.error('Erro inicializando Leaflet:', e);
      // Caso algo dê errado, esconde o mapDiv e mostra mensagem
      mapDiv.style.display = 'none';
      fallback.style.display = 'block';
    }
  </script>
</body>
</html>
      .catch(console.error);
  </script>
</body>
</html>
