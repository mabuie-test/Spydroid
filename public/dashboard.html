<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Dashboard</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <button onclick="logout()">Logout</button>
  <h2>Dashboard</h2>
  <div id="map" style="height:300px;"></div>
  <h3>Chamadas</h3><table id="calls"><thead><tr><th>Num</th><th>Tipo</th><th>Dur</th></tr></thead><tbody></tbody></table>
  <h3>SMS</h3><table id="sms"><thead><tr><th>De</th><th>Texto</th></tr></thead><tbody></tbody></table>
  <script>
    const token = localStorage.getItem('token');
    if (!token) location.href = '/';
    function logout() {
      localStorage.removeItem('token');
      location.href = '/';
    }
    fetch('/api/data', { headers:{ Authorization:'Bearer '+token }})
      .then(r=>r.json()).then(data => {
        const map = L.map('map').setView([0,0],2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        data.forEach(d => {
          const {lat,lng} = d.location;
          L.marker([lat,lng]).addTo(map);
          const trCall = `<tr><td>${d.calls.length}</td><td>-</td><td>-</td></tr>`;
          document.querySelector('#calls tbody').innerHTML += trCall;
          const trSMS = `<tr><td>${d.sms.length}</td><td>-</td></tr>`;
          document.querySelector('#sms tbody').innerHTML += trSMS;
        });
      });
  </script>
</body>
</html>
